<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tree Density Heatmap</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson@3"></script>
    <style>
        .neighborhood {
            stroke: #000;
            stroke-width: 0.5px;
        }
    </style>
</head>

<body>

    <h1>
        Tree Density Heatmap
    </h1>

    <div class="main-graphs">
        <svg id="treevis" width="1000" height="1000"></svg>
        <script>
            const map = async function () {
                // Load the dataset and GeoJSON file
                const treeData = await d3.csv("./Street_Tree_List-2022-01-30_FILTERED.csv");
                const sfNeighborhoods = await d3.json("./SF-Neighborhoods.geo.json");

                // Set up dimensions and projection
                const width = 1000;
                const height = 1000;
                const svg = d3.select("svg#treevis")
                    .attr("width", width)
                    .attr("height", height);
                const projection = d3.geoMercator().fitSize([width, height], topojson.feature(sfNeighborhoods, sfNeighborhoods.objects.SFNeighborhoods));
                const path = d3.geoPath().projection(projection);

                // Convert TopoJSON to GeoJSON
                const features = topojson.feature(sfNeighborhoods, sfNeighborhoods.objects.SFNeighborhoods).features;

                // Calculate tree density for each neighborhood
                const treeDensity = {};
                treeData.forEach(d => {
                    const neighborhood = features.find(f => d3.geoContains(f, [d.Longitude, d.Latitude]));
                    if (neighborhood) {
                        const name = neighborhood.properties.name;
                        if (!treeDensity[name]) {
                            treeDensity[name] = 0;
                        }
                        treeDensity[name]++;
                    }
                });

                // Create a color scale for the density
                const maxDensity = d3.max(Object.values(treeDensity));
                const colorScale = d3.scaleLinear()
                    .domain([0, maxDensity])
                    .range(["#ffffcc", "#000035"]); // Yellow to Navy

                // Draw neighborhood boundaries and fill with density color
                svg.selectAll(".neighborhood")
                    .data(features)
                    .enter().append("path")
                    .attr("class", "neighborhood")
                    .attr("d", path)
                    .attr("fill", d => {
                        const name = d.properties.name;
                        const density = treeDensity[name] || 0;
                        return colorScale(density);
                    });

                // Add a legend
                const legendHeight = 200;
                const legendWidth = 20;
                const legendMargin = { top: 20, right: 50, bottom: 20, left: 20 };

                const legendSvg = svg.append("g")
                    .attr("class", "legend")
                    .attr("transform", `translate(${legendMargin.left},${legendMargin.top})`);

                const legendScale = d3.scaleLinear()
                    .domain([0, maxDensity])
                    .range([legendHeight, 0]);

                const legendAxis = d3.axisRight(legendScale)
                    .tickValues(d3.range(0, maxDensity + 1, Math.ceil(maxDensity / 4)).concat([maxDensity])) // Ensures maxDensity is included
                    .tickFormat(d3.format(".0f"));

                const legendGradient = svg.append("defs").append("linearGradient")
                    .attr("id", "legend-gradient")
                    .attr("x1", "0%")
                    .attr("y1", "100%")
                    .attr("x2", "0%")
                    .attr("y2", "0%");

                legendGradient.append("stop")
                    .attr("offset", "0%")
                    .attr("stop-color", colorScale(0));

                legendGradient.append("stop")
                    .attr("offset", "100%")
                    .attr("stop-color", colorScale(maxDensity));

                legendSvg.append("rect")
                    .attr("width", legendWidth)
                    .attr("height", legendHeight)
                    .style("fill", "url(#legend-gradient)");

                legendSvg.append("g")
                    .attr("transform", `translate(${legendWidth},0)`)
                    .call(legendAxis);
            };
            map();
        </script>
    </div>
</body>

</html>